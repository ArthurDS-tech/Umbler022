const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

/**
 * Script para corrigir problemas do Supabase e fazer limpeza do projeto
 */

console.log('üîß Iniciando corre√ß√£o do Supabase e limpeza do projeto...');

// 1. Verificar e criar arquivo .env se n√£o existir
function createEnvFile() {
  const envPath = path.join(__dirname, '.env');
  
  if (!fs.existsSync(envPath)) {
    console.log('üìù Criando arquivo .env...');
    
    const envContent = `# Configura√ß√µes do Supabase
SUPABASE_URL=https://your-project-id.supabase.co
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key_here

# Configura√ß√µes do banco de dados (fallback)
DATABASE_URL=postgresql://user:password@localhost:5432/umbler_webhook

# Configura√ß√µes da aplica√ß√£o
NODE_ENV=development
PORT=3000
HOST=0.0.0.0

# Configura√ß√µes de seguran√ßa
WEBHOOK_SECRET=your_webhook_secret_here
JWT_SECRET=your_jwt_secret_here

# Configura√ß√µes de CORS
CORS_ORIGIN=http://localhost:3000,http://localhost:3001

# Configura√ß√µes de logging
LOG_LEVEL=info

# Configura√ß√µes de desenvolvimento
AUTO_RELOAD=true
DEBUG_MODE=true
SKIP_DB_CONNECTION=false

# Configura√ß√µes de t√∫nel (ngrok)
AUTO_START_TUNNEL=false
NGROK_AUTH_TOKEN=your_ngrok_auth_token_here

# Configura√ß√µes de rate limiting
RATE_LIMIT_WINDOW_MS=900000
RATE_LIMIT_MAX_REQUESTS=100
RATE_LIMIT_WEBHOOK_MAX=1000

# Configura√ß√µes de upload
MAX_FILE_SIZE=10485760
ALLOWED_MIME_TYPES=image/jpeg,image/png,image/gif,application/pdf,text/plain

# Configura√ß√µes de cache
CACHE_ENABLED=false
CACHE_TTL=300
CACHE_MAX_SIZE=100

# Configura√ß√µes de monitoramento
MONITORING_ENABLED=false
METRICS_PORT=9090

# Configura√ß√µes de backup
BACKUP_ENABLED=false
BACKUP_SCHEDULE=0 2 * * *
BACKUP_RETENTION_DAYS=30

# Configura√ß√µes de limpeza
CLEANUP_ENABLED=false
CLEANUP_SCHEDULE=0 3 * * *
CLEANUP_WEBHOOK_DAYS=30
CLEANUP_MESSAGES_DAYS=365

# URLs e endpoints
WEBHOOK_URL=/webhook/umbler
API_BASE_URL=/api
DASHBOARD_URL=/dashboard
BASE_URL=http://localhost:3000

# Configura√ß√µes de proxy
TRUST_PROXY=false

# Configura√ß√µes de desenvolvimento
MOCK_DATA=false
`;
    
    fs.writeFileSync(envPath, envContent);
    console.log('‚úÖ Arquivo .env criado com sucesso');
    console.log('‚ö†Ô∏è  IMPORTANTE: Configure as credenciais do Supabase no arquivo .env');
  } else {
    console.log('‚úÖ Arquivo .env j√° existe');
  }
}

// 2. Corrigir configura√ß√£o do Supabase
function fixSupabaseConfig() {
  console.log('üîß Corrigindo configura√ß√£o do Supabase...');
  
  const supabaseConfigPath = path.join(__dirname, 'src/config/supabase.js');
  
  if (fs.existsSync(supabaseConfigPath)) {
    let content = fs.readFileSync(supabaseConfigPath, 'utf8');
    
    // Corrigir importa√ß√£o do database
    content = content.replace(
      /const \{ executeQuery, insertWithRetry, updateWithRetry, findWithCache \} = require\('\.\.\/config\/database'\);/g,
      `const { executeQuery, insertWithRetry, updateWithRetry, findWithCache } = require('./database');`
    );
    
    // Adicionar fallback para quando Supabase n√£o estiver configurado
    const fallbackCode = `
// Fallback para quando Supabase n√£o estiver configurado
if (!supabaseUrl || !supabaseKey) {
  logger.warn('‚ö†Ô∏è Supabase n√£o configurado, usando PostgreSQL direto');
  module.exports = {
    supabase: null,
    testConnection: async () => {
      logger.warn('‚ö†Ô∏è Teste de conex√£o Supabase n√£o dispon√≠vel');
      return false;
    },
    executeQuery: async () => {
      throw new Error('Supabase n√£o configurado');
    },
    insertWithRetry: async () => {
      throw new Error('Supabase n√£o configurado');
    },
    updateWithRetry: async () => {
      throw new Error('Supabase n√£o configurado');
    },
    findWithCache: async () => {
      throw new Error('Supabase n√£o configurado');
    },
    executeTransaction: async () => {
      throw new Error('Supabase n√£o configurado');
    },
    healthCheck: async () => {
      return {
        status: 'unhealthy',
        error: 'Supabase n√£o configurado',
        timestamp: new Date().toISOString()
      };
    },
    initializeSupabase: async () => {
      logger.warn('‚ö†Ô∏è Supabase n√£o configurado');
      return false;
    }
  };
  return;
}`;
    
    // Inserir o c√≥digo de fallback ap√≥s a verifica√ß√£o das credenciais
    content = content.replace(
      /if \(!supabaseUrl \|\| !supabaseKey\) \{[\s\S]*?process\.exit\(1\);\s*\}\s*}/,
      `if (!supabaseUrl || !supabaseKey) {
  logger.error('‚ùå Credenciais do Supabase n√£o configuradas');
  logger.info('Configure as seguintes vari√°veis no arquivo .env:');
  logger.info('- SUPABASE_URL=https://your-project-id.supabase.co');
  logger.info('- SUPABASE_SERVICE_ROLE_KEY=your_service_role_key_here');
  
  if (environment.isProduction()) {
    process.exit(1);
  }
}`
    );
    
    // Adicionar o c√≥digo de fallback no final do arquivo
    if (!content.includes('Fallback para quando Supabase n√£o estiver configurado')) {
      content = content.replace(
        /module\.exports = \{[\s\S]*?\};/,
        `module.exports = {
  supabase,
  testConnection: testSupabaseConnection,
  executeQuery,
  insertWithRetry,
  updateWithRetry,
  findWithCache,
  executeTransaction,
  healthCheck,
  initializeSupabase
};

// Fallback para quando Supabase n√£o estiver configurado
if (!supabaseUrl || !supabaseKey) {
  logger.warn('‚ö†Ô∏è Supabase n√£o configurado, usando PostgreSQL direto');
  module.exports = {
    supabase: null,
    testConnection: async () => {
      logger.warn('‚ö†Ô∏è Teste de conex√£o Supabase n√£o dispon√≠vel');
      return false;
    },
    executeQuery: async () => {
      throw new Error('Supabase n√£o configurado');
    },
    insertWithRetry: async () => {
      throw new Error('Supabase n√£o configurado');
    },
    updateWithRetry: async () => {
      throw new Error('Supabase n√£o configurado');
    },
    findWithCache: async () => {
      throw new Error('Supabase n√£o configurado');
    },
    executeTransaction: async () => {
      throw new Error('Supabase n√£o configurado');
    },
    healthCheck: async () => {
      return {
        status: 'unhealthy',
        error: 'Supabase n√£o configurado',
        timestamp: new Date().toISOString()
      };
    },
    initializeSupabase: async () => {
      logger.warn('‚ö†Ô∏è Supabase n√£o configurado');
      return false;
    }
  };
}`
      );
    }
    
    fs.writeFileSync(supabaseConfigPath, content);
    console.log('‚úÖ Configura√ß√£o do Supabase corrigida');
  }
}

// 3. Corrigir servi√ßos para usar Supabase corretamente
function fixServices() {
  console.log('üîß Corrigindo servi√ßos...');
  
  // Corrigir webhookService.js
  const webhookServicePath = path.join(__dirname, 'src/services/webhookService.js');
  if (fs.existsSync(webhookServicePath)) {
    let content = fs.readFileSync(webhookServicePath, 'utf8');
    
    // Corrigir importa√ß√£o
    content = content.replace(
      /const \{ executeQuery, insertWithRetry, updateWithRetry, findWithCache \} = require\('\.\.\/config\/database'\);/g,
      `const { executeQuery, insertWithRetry, updateWithRetry, findWithCache } = require('../config/database');`
    );
    
    // Adicionar tratamento de erro para Supabase
    content = content.replace(
      /async processWebhook\(payload, webhookEventId = null\) \{/,
      `async processWebhook(payload, webhookEventId = null) {
    try {
      // Verificar se Supabase est√° configurado
      const { supabase } = require('../config/supabase');
      if (!supabase) {
        logger.warn('‚ö†Ô∏è Supabase n√£o configurado, processando apenas localmente');
        return {
          eventType: 'unknown',
          processed: false,
          error: 'Supabase n√£o configurado'
        };
      }`
    );
    
    fs.writeFileSync(webhookServicePath, content);
    console.log('‚úÖ webhookService.js corrigido');
  }
  
  // Corrigir mensagensWebhookService.js
  const mensagensServicePath = path.join(__dirname, 'src/services/mensagensWebhookService.js');
  if (fs.existsSync(mensagensServicePath)) {
    let content = fs.readFileSync(mensagensServicePath, 'utf8');
    
    // Corrigir importa√ß√£o
    content = content.replace(
      /const \{ executeQuery, insertWithRetry, findWithCache \} = require\('\.\.\/config\/database'\);/g,
      `const { executeQuery, insertWithRetry, findWithCache } = require('../config/database');`
    );
    
    // Adicionar verifica√ß√£o de Supabase
    content = content.replace(
      /async processarMensagemWebhook\(payload\) \{/,
      `async processarMensagemWebhook(payload) {
    try {
      // Verificar se Supabase est√° configurado
      const { supabase } = require('../config/supabase');
      if (!supabase) {
        logger.warn('‚ö†Ô∏è Supabase n√£o configurado, pulando processamento de mensagem webhook');
        return null;
      }`
    );
    
    fs.writeFileSync(mensagensServicePath, content);
    console.log('‚úÖ mensagensWebhookService.js corrigido');
  }
}

// 4. Criar script de teste do Supabase
function createSupabaseTest() {
  console.log('üß™ Criando script de teste do Supabase...');
  
  const testScript = `const { supabase, testConnection } = require('./src/config/supabase');
const logger = require('./src/utils/logger');

async function testSupabaseConnection() {
  try {
    console.log('üîç Testando conex√£o com Supabase...');
    
    if (!supabase) {
      console.log('‚ùå Supabase n√£o configurado');
      console.log('Configure as vari√°veis de ambiente:');
      console.log('- SUPABASE_URL');
      console.log('- SUPABASE_SERVICE_ROLE_KEY');
      return false;
    }
    
    const isConnected = await testConnection();
    
    if (isConnected) {
      console.log('‚úÖ Conex√£o com Supabase estabelecida');
      
      // Testar inser√ß√£o
      console.log('üß™ Testando inser√ß√£o...');
      const testData = {
        event_type: 'test',
        event_date: new Date().toISOString(),
        payload: { test: true },
        processed: false
      };
      
      const { data, error } = await supabase
        .from('webhook_events')
        .insert(testData)
        .select()
        .single();
      
      if (error) {
        console.log('‚ùå Erro na inser√ß√£o:', error.message);
        return false;
      }
      
      console.log('‚úÖ Inser√ß√£o testada com sucesso');
      
      // Limpar dados de teste
      await supabase
        .from('webhook_events')
        .delete()
        .eq('event_type', 'test');
      
      console.log('‚úÖ Dados de teste removidos');
      return true;
      
    } else {
      console.log('‚ùå Falha na conex√£o com Supabase');
      return false;
    }
    
  } catch (error) {
    console.log('‚ùå Erro no teste:', error.message);
    return false;
  }
}

// Executar teste
testSupabaseConnection().then(success => {
  if (success) {
    console.log('üéâ Teste do Supabase conclu√≠do com sucesso!');
    process.exit(0);
  } else {
    console.log('üí• Teste do Supabase falhou!');
    process.exit(1);
  }
});`;
  
  fs.writeFileSync(path.join(__dirname, 'test-supabase-connection.js'), testScript);
  console.log('‚úÖ Script de teste do Supabase criado');
}

// 5. Limpar arquivos desnecess√°rios
function cleanupFiles() {
  console.log('üßπ Limpando arquivos desnecess√°rios...');
  
  const filesToRemove = [
    // Manuais antigos
    'GUIA_DEPLOY_COMPLETO.md',
    'GUIA-INTEGRACAO-FRONTEND.md',
    'RESUMO_FRONTEND_COMPLETO.md',
    'RESUMO-INTEGRACAO.md',
    'ERRO_CORRIGIDO_README.md',
    'PROBLEMA_IDENTIFICADO.md',
    'RESOLVER_ERRO_SUPABASE.md',
    'RESUMO_SOLUCAO_SUPABASE.md',
    'SOLUCAO_PROBLEMAS_SUPABASE.md',
    'BACKEND_LIMPO.md',
    'CONFIGURACAO_SUPABASE.md',
    'GUIA_SEGURANCA_SUPABASE.md',
    'MIGRACAO-COMPLETA.md',
    'README-MIGRACAO-POSTGRESQL.md',
    'README-SUPABASE-SETUP.md',
    'SISTEMA_TEMPO_RESPOSTA_ATENDENTE.md',
    'WEBHOOK-GUIDE.md',
    'QUICK-START.md',
    
    // Scripts de teste antigos
    'test-mensagens-webhook.js',
    'testar-webhook-completo.js',
    'testar-tempo-resposta-atendente.js',
    'test-webhook-supabase.js',
    'test-webhook-insertion.js',
    'diagnosticar-supabase.js',
    'configurar-supabase-real.js',
    'setup-supabase-complete.js',
    'setup-supabase-credentials.js',
    'setup-mensagens-webhook.js',
    'setup-database-tables.js',
    'setup-completo.js',
    'apply-security-fixes.js',
    'fix-security-issues.sql',
    'fix-security-simple.sql',
    'fix-supabase-configuration.js',
    'create-agent-response-table.sql',
    
    // Arquivos vazios
    '.eslintrc.js',
    'nodemon',
    'umbler-webhook-backend@1.0.0'
  ];
  
  let removedCount = 0;
  
  filesToRemove.forEach(file => {
    const filePath = path.join(__dirname, file);
    if (fs.existsSync(filePath)) {
      try {
        fs.unlinkSync(filePath);
        console.log(`üóëÔ∏è  Removido: ${file}`);
        removedCount++;
      } catch (error) {
        console.log(`‚ö†Ô∏è  Erro ao remover ${file}:`, error.message);
      }
    }
  });
  
  console.log(`‚úÖ ${removedCount} arquivos removidos`);
}

// 6. Remover pasta frontend
function removeFrontend() {
  console.log('üóëÔ∏è  Removendo pasta frontend...');
  
  const frontendPath = path.join(__dirname, '..', 'frontend');
  if (fs.existsSync(frontendPath)) {
    try {
      // Remover recursivamente
      const removeDir = (dir) => {
        if (fs.existsSync(dir)) {
          fs.readdirSync(dir).forEach(file => {
            const curPath = path.join(dir, file);
            if (fs.lstatSync(curPath).isDirectory()) {
              removeDir(curPath);
            } else {
              fs.unlinkSync(curPath);
            }
          });
          fs.rmdirSync(dir);
        }
      };
      
      removeDir(frontendPath);
      console.log('‚úÖ Pasta frontend removida');
    } catch (error) {
      console.log('‚ö†Ô∏è  Erro ao remover pasta frontend:', error.message);
    }
  } else {
    console.log('‚ÑπÔ∏è  Pasta frontend n√£o encontrada');
  }
}

// 7. Remover pasta Umbler-2
function removeUmbler2() {
  console.log('üóëÔ∏è  Removendo pasta Umbler-2...');
  
  const umbler2Path = path.join(__dirname, '..', 'Umbler-2');
  if (fs.existsSync(umbler2Path)) {
    try {
      // Remover recursivamente
      const removeDir = (dir) => {
        if (fs.existsSync(dir)) {
          fs.readdirSync(dir).forEach(file => {
            const curPath = path.join(dir, file);
            if (fs.lstatSync(curPath).isDirectory()) {
              removeDir(curPath);
            } else {
              fs.unlinkSync(curPath);
            }
          });
          fs.rmdirSync(dir);
        }
      };
      
      removeDir(umbler2Path);
      console.log('‚úÖ Pasta Umbler-2 removida');
    } catch (error) {
      console.log('‚ö†Ô∏è  Erro ao remover pasta Umbler-2:', error.message);
    }
  } else {
    console.log('‚ÑπÔ∏è  Pasta Umbler-2 n√£o encontrada');
  }
}

// 8. Criar README atualizado
function createUpdatedReadme() {
  console.log('üìù Criando README atualizado...');
  
  const readmeContent = `# Umbler Webhook Backend

Backend para processamento de webhooks da Umbler com integra√ß√£o ao Supabase.

## üöÄ Configura√ß√£o R√°pida

### 1. Instalar depend√™ncias
\`\`\`bash
npm install
\`\`\`

### 2. Configurar vari√°veis de ambiente
Copie o arquivo \`.env.example\` para \`.env\` e configure:

\`\`\`env
# Supabase (obrigat√≥rio)
SUPABASE_URL=https://your-project-id.supabase.co
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key_here

# Banco de dados (fallback)
DATABASE_URL=postgresql://user:password@localhost:5432/umbler_webhook

# Aplica√ß√£o
NODE_ENV=development
PORT=3000
WEBHOOK_SECRET=your_webhook_secret_here
\`\`\`

### 3. Testar conex√£o com Supabase
\`\`\`bash
node test-supabase-connection.js
\`\`\`

### 4. Iniciar servidor
\`\`\`bash
npm start
\`\`\`

## üìã Endpoints

- \`POST /webhook/umbler\` - Receber webhooks da Umbler
- \`GET /webhook/test\` - Teste de conectividade
- \`GET /api/health\` - Health check
- \`GET /api/stats\` - Estat√≠sticas

## üîß Desenvolvimento

\`\`\`bash
# Modo desenvolvimento com auto-reload
npm run dev

# Testar webhook
curl -X POST http://localhost:3000/webhook/test
\`\`\`

## üìä Monitoramento

- Logs: \`logs/app.log\`
- Health check: \`/api/health\`
- Estat√≠sticas: \`/api/stats\`

## üõ†Ô∏è Estrutura do Projeto

\`\`\`
src/
‚îú‚îÄ‚îÄ config/          # Configura√ß√µes
‚îú‚îÄ‚îÄ controllers/     # Controllers
‚îú‚îÄ‚îÄ middleware/      # Middlewares
‚îú‚îÄ‚îÄ routes/          # Rotas
‚îú‚îÄ‚îÄ services/        # Servi√ßos
‚îî‚îÄ‚îÄ utils/           # Utilit√°rios
\`\`\`

## üîí Seguran√ßa

- Valida√ß√£o de assinatura de webhook
- Rate limiting
- CORS configur√°vel
- Logs de auditoria

## üìà Funcionalidades

- ‚úÖ Processamento de webhooks da Umbler
- ‚úÖ Integra√ß√£o com Supabase
- ‚úÖ C√°lculo de tempo de resposta
- ‚úÖ Estat√≠sticas em tempo real
- ‚úÖ Sistema de retry autom√°tico
- ‚úÖ Logs detalhados
- ‚úÖ Health checks

## üÜò Suporte

Para problemas com Supabase:
1. Verifique as credenciais no arquivo \`.env\`
2. Execute \`node test-supabase-connection.js\`
3. Verifique os logs em \`logs/app.log\`
`;

  fs.writeFileSync(path.join(__dirname, 'README.md'), readmeContent);
  console.log('‚úÖ README atualizado');
}

// 9. Executar todas as corre√ß√µes
async function runAllFixes() {
  try {
    console.log('üöÄ Iniciando corre√ß√£o completa do projeto...\n');
    
    createEnvFile();
    console.log('');
    
    fixSupabaseConfig();
    console.log('');
    
    fixServices();
    console.log('');
    
    createSupabaseTest();
    console.log('');
    
    cleanupFiles();
    console.log('');
    
    removeFrontend();
    console.log('');
    
    removeUmbler2();
    console.log('');
    
    createUpdatedReadme();
    console.log('');
    
    console.log('üéâ Corre√ß√£o completa finalizada!');
    console.log('');
    console.log('üìã Pr√≥ximos passos:');
    console.log('1. Configure as credenciais do Supabase no arquivo .env');
    console.log('2. Execute: node test-supabase-connection.js');
    console.log('3. Execute: npm start');
    console.log('');
    console.log('‚úÖ Projeto limpo e configurado!');
    
  } catch (error) {
    console.error('‚ùå Erro durante a corre√ß√£o:', error);
    process.exit(1);
  }
}

// Executar se chamado diretamente
if (require.main === module) {
  runAllFixes();
}

module.exports = {
  createEnvFile,
  fixSupabaseConfig,
  fixServices,
  createSupabaseTest,
  cleanupFiles,
  removeFrontend,
  removeUmbler2,
  createUpdatedReadme,
  runAllFixes
};
